"use strict";(self.webpackChunkblastarians=self.webpackChunkblastarians||[]).push([[750],{30750:(t,r,e)=>{e.r(r),e.d(r,{Marketplace:()=>W});var a=e(54705),i=e(90789),n=e(18886),s=e(94811),o=e(57305),c=e(59355),d=e(2776),p=e(64301),g=e(81237),h=e(48987),l=e(10974),u=e(73594),f=e(3404);let w=function(t){return t[t.Direct=0]="Direct",t[t.Auction=1]="Auction",t}({});class m{constructor(t,r){(0,a.A)(this,"createListing",(0,n.dt)((async t=>{(0,n.dD)(t);const r=await(0,n.cG)(t.assetContractAddress),e=await(0,n.cG)(t.currencyContractAddress);await(0,n.dE)(this.contractWrapper,this.getAddress(),r,t.tokenId,await this.contractWrapper.getSignerAddress());const a=await(0,n.ba)(this.contractWrapper.getProvider(),t.buyoutPricePerToken,e);let i=Math.floor(t.startTimestamp.getTime()/1e3);const s=(await this.contractWrapper.getProvider().getBlock("latest")).timestamp;return i<s&&(i=s),n.aW.fromContractWrapper({contractWrapper:this.contractWrapper,method:"createListing",args:[{assetContract:r,tokenId:t.tokenId,buyoutPricePerToken:a,currencyToAccept:(0,n.b9)(e),listingType:w.Direct,quantityToList:t.quantity,reservePricePerToken:a,secondsUntilEndTime:t.listingDurationInSeconds,startTime:d.gH.from(i)}],parse:t=>({id:this.contractWrapper.parseLogs("ListingAdded",null===t||void 0===t?void 0:t.logs)[0].args.listingId,receipt:t})})}))),(0,a.A)(this,"createListingsBatch",(0,n.dt)((async t=>{const r=await Promise.all(t.map((async t=>(await this.createListing.prepare(t)).encode())));return n.aW.fromContractWrapper({contractWrapper:this.contractWrapper,method:"multicall",args:[r],parse:t=>this.contractWrapper.parseLogs("ListingAdded",null===t||void 0===t?void 0:t.logs).map((r=>({id:r.args.listingId,receipt:t})))})}))),(0,a.A)(this,"makeOffer",(0,n.dt)((async(t,r,e,a,i)=>{if((0,n.b8)(e))throw new Error("You must use the wrapped native token address when making an offer with a native token");const s=await(0,n.ba)(this.contractWrapper.getProvider(),a,e);try{await this.getListing(t)}catch(l){throw console.error("Failed to get listing, err =",l),new Error("Error getting the listing with id ".concat(t))}const o=d.gH.from(r),c=d.gH.from(s).mul(o),g=await this.contractWrapper.getCallOverrides()||{};await(0,n.bd)(this.contractWrapper,c,e,g);let h=p.Is;return i&&(h=d.gH.from(Math.floor(i.getTime()/1e3))),n.aW.fromContractWrapper({contractWrapper:this.contractWrapper,method:"offer",args:[t,r,e,s,h],overrides:g})}))),(0,a.A)(this,"acceptOffer",(0,n.dt)((async(t,r)=>{await this.validateListing(d.gH.from(t));const e=await(0,n.cG)(r),a=await this.contractWrapper.readContract.offers(t,e);return n.aW.fromContractWrapper({contractWrapper:this.contractWrapper,method:"acceptOffer",args:[t,e,a.currency,a.pricePerToken]})}))),(0,a.A)(this,"buyoutListing",(0,n.dt)((async(t,r,e)=>{const a=await this.validateListing(d.gH.from(t)),{valid:i,error:s}=await this.isStillValidListing(a,r);if(!i)throw new Error("Listing ".concat(t," is no longer valid. ").concat(s));const o=e||await this.contractWrapper.getSignerAddress(),c=d.gH.from(r),p=d.gH.from(a.buyoutPrice).mul(c),g=await this.contractWrapper.getCallOverrides()||{};return await(0,n.bd)(this.contractWrapper,p,a.currencyContractAddress,g),n.aW.fromContractWrapper({contractWrapper:this.contractWrapper,method:"buy",args:[t,o,c,a.currencyContractAddress,p],overrides:g})}))),(0,a.A)(this,"updateListing",(0,n.dt)((async t=>n.aW.fromContractWrapper({contractWrapper:this.contractWrapper,method:"updateListing",args:[t.id,t.quantity,t.buyoutPrice,t.buyoutPrice,await(0,n.cG)(t.currencyContractAddress),t.startTimeInSeconds,t.secondsUntilEnd]})))),(0,a.A)(this,"cancelListing",(0,n.dt)((async t=>n.aW.fromContractWrapper({contractWrapper:this.contractWrapper,method:"cancelDirectListing",args:[t]})))),this.contractWrapper=t,this.storage=r}getAddress(){return this.contractWrapper.readContract.address}async getListing(t){const r=await this.contractWrapper.readContract.listings(t);if(r.assetContract===g.L)throw new n.bx(this.getAddress(),t.toString());if(r.listingType!==w.Direct)throw new n.by(this.getAddress(),t.toString(),"Auction","Direct");return await this.mapListing(r)}async getActiveOffer(t,r){await this.validateListing(d.gH.from(t)),(0,f.A)(h.isAddress(r),"Address must be a valid address");const e=await this.contractWrapper.readContract.offers(t,await(0,n.cG)(r));if(e.offeror!==g.L)return await(0,n.dA)(this.contractWrapper.getProvider(),d.gH.from(t),e)}async validateListing(t){try{return await this.getListing(t)}catch(r){throw console.error("Error getting the listing with id ".concat(t)),r}}async mapListing(t){return{assetContractAddress:t.assetContract,buyoutPrice:d.gH.from(t.buyoutPricePerToken),currencyContractAddress:t.currency,buyoutCurrencyValuePerToken:await(0,n.bc)(this.contractWrapper.getProvider(),t.currency,t.buyoutPricePerToken),id:t.listingId.toString(),tokenId:t.tokenId,quantity:t.quantity,startTimeInSeconds:t.startTime,asset:await(0,n.dB)(t.assetContract,this.contractWrapper.getProvider(),t.tokenId,this.storage),secondsUntilEnd:t.endTime,sellerAddress:t.tokenOwner,type:w.Direct}}async isStillValidListing(t,r){if(!await(0,n.dC)(this.contractWrapper.getProvider(),this.getAddress(),t.assetContractAddress,t.tokenId,t.sellerAddress))return{valid:!1,error:"Token '".concat(t.tokenId,"' from contract '").concat(t.assetContractAddress,"' is not approved for transfer")};const e=this.contractWrapper.getProvider(),a=new l.NZ(t.assetContractAddress,s,e),i=await a.supportsInterface(n.cP),d=await a.supportsInterface(n.cQ);if(i){var p;const r=new l.NZ(t.assetContractAddress,o,e);let a;try{a=await r.ownerOf(t.tokenId)}catch(g){}const i=(null===(p=a)||void 0===p?void 0:p.toLowerCase())===t.sellerAddress.toLowerCase();return{valid:i,error:i?void 0:"Seller is not the owner of Token '".concat(t.tokenId,"' from contract '").concat(t.assetContractAddress," anymore'")}}if(d){const a=new l.NZ(t.assetContractAddress,c,e),i=(await a.balanceOf(t.sellerAddress,t.tokenId)).gte(r||t.quantity);return{valid:i,error:i?void 0:"Seller does not have enough balance of Token '".concat(t.tokenId,"' from contract '").concat(t.assetContractAddress," to fulfill the listing")}}return{valid:!1,error:"Contract does not implement ERC 1155 or ERC 721."}}}class y{constructor(t,r){(0,a.A)(this,"createListing",(0,n.dt)((async t=>{(0,n.dD)(t);const r=await(0,n.cG)(t.assetContractAddress),e=await(0,n.cG)(t.currencyContractAddress);await(0,n.dE)(this.contractWrapper,this.getAddress(),r,t.tokenId,await this.contractWrapper.getSignerAddress());const a=await(0,n.ba)(this.contractWrapper.getProvider(),t.buyoutPricePerToken,e),i=await(0,n.ba)(this.contractWrapper.getProvider(),t.reservePricePerToken,e);let s=Math.floor(t.startTimestamp.getTime()/1e3);const o=(await this.contractWrapper.getProvider().getBlock("latest")).timestamp;return s<o&&(s=o),n.aW.fromContractWrapper({contractWrapper:this.contractWrapper,method:"createListing",args:[{assetContract:r,tokenId:t.tokenId,buyoutPricePerToken:a,currencyToAccept:(0,n.b9)(e),listingType:w.Auction,quantityToList:t.quantity,reservePricePerToken:i,secondsUntilEndTime:t.listingDurationInSeconds,startTime:d.gH.from(s)}],parse:t=>({id:this.contractWrapper.parseLogs("ListingAdded",null===t||void 0===t?void 0:t.logs)[0].args.listingId,receipt:t})})}))),(0,a.A)(this,"createListingsBatch",(0,n.dt)((async t=>{const r=await Promise.all(t.map((async t=>(await this.createListing.prepare(t)).encode())));return n.aW.fromContractWrapper({contractWrapper:this.contractWrapper,method:"multicall",args:[r],parse:t=>this.contractWrapper.parseLogs("ListingAdded",null===t||void 0===t?void 0:t.logs).map((r=>({id:r.args.listingId,receipt:t})))})}))),(0,a.A)(this,"buyoutListing",(0,n.dt)((async t=>{const r=await this.validateListing(d.gH.from(t)),e=await(0,n.bb)(this.contractWrapper.getProvider(),r.currencyContractAddress);return this.makeBid.prepare(t,u.formatUnits(r.buyoutPrice,e.decimals))}))),(0,a.A)(this,"makeBid",(0,n.dt)((async(t,r)=>{const e=await this.validateListing(d.gH.from(t)),a=await(0,n.ba)(this.contractWrapper.getProvider(),r,e.currencyContractAddress);if(a.eq(d.gH.from(0)))throw new Error("Cannot make a bid with 0 value");const i=await this.contractWrapper.readContract.bidBufferBps(),s=await this.getWinningBid(t);if(s){const t=(0,n.dF)(s.pricePerToken,a,i);(0,f.A)(t,"Bid price is too low based on the current winning bid and the bid buffer")}else{const t=a,r=d.gH.from(e.reservePrice);(0,f.A)(t.gte(r),"Bid price is too low based on reserve price")}const o=d.gH.from(e.quantity),c=a.mul(o),g=await this.contractWrapper.getCallOverrides()||{};return await(0,n.bd)(this.contractWrapper,c,e.currencyContractAddress,g),n.aW.fromContractWrapper({contractWrapper:this.contractWrapper,method:"offer",args:[t,e.quantity,e.currencyContractAddress,a,p.Is],overrides:g})}))),(0,a.A)(this,"cancelListing",(0,n.dt)((async t=>{const r=await this.validateListing(d.gH.from(t)),e=d.gH.from(Math.floor(Date.now()/1e3)),a=d.gH.from(r.startTimeInEpochSeconds),i=await this.contractWrapper.readContract.winningBid(t);if(e.gt(a)&&i.offeror!==g.L)throw new n.bv(t.toString());return n.aW.fromContractWrapper({contractWrapper:this.contractWrapper,method:"closeAuction",args:[d.gH.from(t),await this.contractWrapper.getSignerAddress()]})}))),(0,a.A)(this,"closeListing",(0,n.dt)((async(t,r)=>{r||(r=await this.contractWrapper.getSignerAddress());const e=await this.validateListing(d.gH.from(t));try{return n.aW.fromContractWrapper({contractWrapper:this.contractWrapper,method:"closeAuction",args:[d.gH.from(t),r]})}catch(a){throw a.message.includes("cannot close auction before it has ended")?new n.bB(t.toString(),e.endTimeInEpochSeconds.toString()):a}}))),(0,a.A)(this,"executeSale",(0,n.dt)((async t=>{const r=await this.validateListing(d.gH.from(t));try{const e=await this.getWinningBid(t);(0,f.A)(e,"No winning bid found");const a=this.encoder.encode("closeAuction",[t,r.sellerAddress]),i=this.encoder.encode("closeAuction",[t,e.buyerAddress]);return n.aW.fromContractWrapper({contractWrapper:this.contractWrapper,method:"multicall",args:[a,i]})}catch(e){throw e.message.includes("cannot close auction before it has ended")?new n.bB(t.toString(),r.endTimeInEpochSeconds.toString()):e}}))),(0,a.A)(this,"updateListing",(0,n.dt)((async t=>n.aW.fromContractWrapper({contractWrapper:this.contractWrapper,method:"updateListing",args:[t.id,t.quantity,t.reservePrice,t.buyoutPrice,t.currencyContractAddress,t.startTimeInEpochSeconds,t.endTimeInEpochSeconds]})))),this.contractWrapper=t,this.storage=r,this.encoder=new n.ag(t)}getAddress(){return this.contractWrapper.readContract.address}async getListing(t){const r=await this.contractWrapper.readContract.listings(t);if(r.listingId.toString()!==t.toString())throw new n.bx(this.getAddress(),t.toString());if(r.listingType!==w.Auction)throw new n.by(this.getAddress(),t.toString(),"Direct","Auction");return await this.mapListing(r)}async getWinningBid(t){await this.validateListing(d.gH.from(t));const r=await this.contractWrapper.readContract.winningBid(t);if(r.offeror!==g.L)return await(0,n.dA)(this.contractWrapper.getProvider(),d.gH.from(t),r)}async getWinner(t){const r=await this.validateListing(d.gH.from(t)),e=await this.contractWrapper.readContract.winningBid(t),a=d.gH.from(Math.floor(Date.now()/1e3)),i=d.gH.from(r.endTimeInEpochSeconds);if(a.gt(i)&&e.offeror!==g.L)return e.offeror;const n=(await this.contractWrapper.readContract.queryFilter(this.contractWrapper.readContract.filters.AuctionClosed())).find((r=>r.args.listingId.eq(d.gH.from(t))));if(!n)throw new Error("Could not find auction with listingId ".concat(t," in closed auctions"));return n.args.winningBidder}async getBidBufferBps(){return this.contractWrapper.readContract.bidBufferBps()}async getMinimumNextBid(t){const[r,e,a]=await Promise.all([this.getBidBufferBps(),this.getWinningBid(t),await this.validateListing(d.gH.from(t))]),i=e?e.currencyValue.value:a.reservePrice,s=i.add(i.mul(r).div(1e4));return(0,n.bc)(this.contractWrapper.getProvider(),a.currencyContractAddress,s)}async validateListing(t){try{return await this.getListing(t)}catch(r){throw console.error("Error getting the listing with id ".concat(t)),r}}async mapListing(t){return{assetContractAddress:t.assetContract,buyoutPrice:d.gH.from(t.buyoutPricePerToken),currencyContractAddress:t.currency,buyoutCurrencyValuePerToken:await(0,n.bc)(this.contractWrapper.getProvider(),t.currency,t.buyoutPricePerToken),id:t.listingId.toString(),tokenId:t.tokenId,quantity:t.quantity,startTimeInEpochSeconds:t.startTime,asset:await(0,n.dB)(t.assetContract,this.contractWrapper.getProvider(),t.tokenId,this.storage),reservePriceCurrencyValuePerToken:await(0,n.bc)(this.contractWrapper.getProvider(),t.currency,t.reservePricePerToken),reservePrice:d.gH.from(t.reservePricePerToken),endTimeInEpochSeconds:t.endTime,sellerAddress:t.tokenOwner,type:w.Auction}}}e(6373),e(3198),e(122),e(75838),e(99038),e(92377);class W{get chainId(){return this._chainId}constructor(t,r,e){(0,a.A)(this,"getAll",this.getAllListings),(0,a.A)(this,"buyoutListing",(0,n.dt)((async(t,r,e)=>{const a=await this.contractWrapper.readContract.listings(t);if(a.listingId.toString()!==t.toString())throw new n.bx(this.getAddress(),t.toString());switch(a.listingType){case w.Direct:return(0,f.A)(void 0!==r,"quantityDesired is required when buying out a direct listing"),await this.direct.buyoutListing.prepare(t,r,e);case w.Auction:return await this.auction.buyoutListing.prepare(t);default:throw Error("Unknown listing type: ".concat(a.listingType))}}))),(0,a.A)(this,"makeOffer",(0,n.dt)((async(t,r,e)=>{const a=await this.contractWrapper.readContract.listings(t);if(a.listingId.toString()!==t.toString())throw new n.bx(this.getAddress(),t.toString());const i=await this.contractWrapper.getChainID();switch(a.listingType){case w.Direct:return(0,f.A)(e,"quantity is required when making an offer on a direct listing"),await this.direct.makeOffer.prepare(t,e,(0,n.b8)(a.currency)?n.cS[i].wrapped.address:a.currency,r);case w.Auction:return await this.auction.makeBid.prepare(t,r);default:throw Error("Unknown listing type: ".concat(a.listingType))}}))),(0,a.A)(this,"setBidBufferBps",(0,n.dt)((async t=>{await this.roles.verify(["admin"],await this.contractWrapper.getSignerAddress());const r=await this.getTimeBufferInSeconds();return n.aW.fromContractWrapper({contractWrapper:this.contractWrapper,method:"setAuctionBuffers",args:[r,d.gH.from(t)]})}))),(0,a.A)(this,"setTimeBufferInSeconds",(0,n.dt)((async t=>{await this.roles.verify(["admin"],await this.contractWrapper.getSignerAddress());const r=await this.getBidBufferBps();return n.aW.fromContractWrapper({contractWrapper:this.contractWrapper,method:"setAuctionBuffers",args:[d.gH.from(t),r]})}))),(0,a.A)(this,"allowListingFromSpecificAssetOnly",(0,n.dt)((async t=>{const r=[];return(await this.roles.get("asset")).includes(g.L)&&r.push(this.encoder.encode("revokeRole",[(0,n.bI)("asset"),g.L])),r.push(this.encoder.encode("grantRole",[(0,n.bI)("asset"),t])),n.aW.fromContractWrapper({contractWrapper:this.contractWrapper,method:"multicall",args:[r]})}))),(0,a.A)(this,"allowListingFromAnyAsset",(0,n.dt)((async()=>{const t=[],r=await this.roles.get("asset");for(const e in r)t.push(this.encoder.encode("revokeRole",[(0,n.bI)("asset"),e]));return t.push(this.encoder.encode("grantRole",[(0,n.bI)("asset"),g.L])),n.aW.fromContractWrapper({contractWrapper:this.contractWrapper,method:"multicall",args:[t]})})));let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},s=arguments.length>4?arguments[4]:void 0,o=arguments.length>5?arguments[5]:void 0,c=arguments.length>6&&void 0!==arguments[6]?arguments[6]:new n.ds(t,r,s,i,e);this._chainId=o,this.abi=n.e.parse(s||[]),this.contractWrapper=c,this.storage=e,this.metadata=new n.ah(this.contractWrapper,n.dK,this.storage),this.app=new n.b0(this.contractWrapper,this.metadata,this.storage),this.roles=new n.ai(this.contractWrapper,W.contractRoles),this.encoder=new n.ag(this.contractWrapper),this.estimator=new n.aQ(this.contractWrapper),this.direct=new m(this.contractWrapper,this.storage),this.auction=new y(this.contractWrapper,this.storage),this.events=new n.aR(this.contractWrapper),this.platformFees=new n.aT(this.contractWrapper),this.interceptor=new n.aS(this.contractWrapper)}onNetworkUpdated(t){this.contractWrapper.updateSignerOrProvider(t)}getAddress(){return this.contractWrapper.readContract.address}async getListing(t){const r=await this.contractWrapper.readContract.listings(t);if(r.assetContract===g.L)throw new n.bx(this.getAddress(),t.toString());switch(r.listingType){case w.Auction:return await this.auction.mapListing(r);case w.Direct:return await this.direct.mapListing(r);default:throw new Error("Unknown listing type: ".concat(r.listingType))}}async getActiveListings(t){const r=await this.getAllListingsNoFilter(!0),e=this.applyFilter(r,t),a=d.gH.from(Math.floor(Date.now()/1e3));return e.filter((t=>t.type===w.Auction&&d.gH.from(t.endTimeInEpochSeconds).gt(a)&&d.gH.from(t.startTimeInEpochSeconds).lte(a)||t.type===w.Direct&&d.gH.from(t.quantity).gt(0)))}async getAllListings(t){const r=await this.getAllListingsNoFilter(!1);return this.applyFilter(r,t)}async getTotalCount(){return await this.contractWrapper.readContract.totalListings()}async isRestrictedToListerRoleOnly(){return!await this.contractWrapper.readContract.hasRole((0,n.bI)("lister"),g.L)}async getBidBufferBps(){return this.contractWrapper.readContract.bidBufferBps()}async getTimeBufferInSeconds(){return this.contractWrapper.readContract.timeBuffer()}async getOffers(t){const r=await this.events.getEvents("NewOffer",{order:"desc",filters:{listingId:t}});return await Promise.all(r.map((async r=>await(0,n.dA)(this.contractWrapper.getProvider(),d.gH.from(t),{quantityWanted:r.data.quantityWanted,pricePerToken:r.data.quantityWanted.gt(0)?r.data.totalOfferAmount.div(r.data.quantityWanted):r.data.totalOfferAmount,currency:r.data.currency,offeror:r.data.offeror}))))}async getAllListingsNoFilter(t){return(await Promise.all(Array.from(Array((await this.contractWrapper.readContract.totalListings()).toNumber()).keys()).map((async r=>{let e;try{e=await this.getListing(r)}catch(a){return a instanceof n.bx?void 0:void console.warn("Failed to get listing ".concat(r,"' - skipping. Try 'marketplace.getListing(").concat(r,")' to get the underlying error."))}if(e.type===w.Auction)return e;if(t){const{valid:t}=await this.direct.isStillValidListing(e);if(!t)return}return e})))).filter((t=>void 0!==t))}applyFilter(t,r){let e=[...t];const a=d.gH.from((null===r||void 0===r?void 0:r.start)||0).toNumber(),n=d.gH.from((null===r||void 0===r?void 0:r.count)||i.D).toNumber();return r&&(r.seller&&(e=e.filter((t=>{var e;return t.sellerAddress.toString().toLowerCase()===(null===r||void 0===r||null===(e=r.seller)||void 0===e?void 0:e.toString().toLowerCase())}))),r.tokenContract&&(e=e.filter((t=>{var e;return t.assetContractAddress.toString().toLowerCase()===(null===r||void 0===r||null===(e=r.tokenContract)||void 0===e?void 0:e.toString().toLowerCase())}))),void 0!==r.tokenId&&(e=e.filter((t=>{var e;return t.tokenId.toString()===(null===r||void 0===r||null===(e=r.tokenId)||void 0===e?void 0:e.toString())}))),e=e.filter(((t,r)=>r>=a)),e=e.slice(0,n)),e}async prepare(t,r,e){return n.aW.fromContractWrapper({contractWrapper:this.contractWrapper,method:t,args:r,overrides:e})}async call(t,r,e){return this.contractWrapper.call(t,r,e)}}(0,a.A)(W,"contractRoles",n.dJ)}}]);
//# sourceMappingURL=750.8ec9bc78.chunk.js.map